<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PROMIS v2.0 – Satisfacción con la vida sexual</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 1.5rem;
      line-height: 1.5;
      background: #f7f7f7;
    }
    h1, h2 { text-align: center; }
    .card {
      background: #ffffff;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .question {
      margin-bottom: 1.2rem;
      padding-bottom: 0.8rem;
      border-bottom: 1px solid #eee;
    }
    .question:last-of-type { border-bottom: none; }
    .options { display: flex; flex-wrap: wrap; gap: 0.4rem 1.5rem; }
    label { cursor: pointer; }
    .small-muted { font-size: 0.85rem; color: #666; }
    textarea {
      width: 100%;
      min-height: 150px;
      font-family: monospace;
      font-size: 0.9rem;
    }
    button {
      padding: 0.7rem 1.3rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }
    #submitBtn { background: #2563eb; color: white; }
    #downloadCsvBtn, #copyBtn { background: #ddd; margin-top: 0.5rem; margin-right: 0.5rem; }
    #resultsCard { display: none; }
  </style>
</head>
<body>

<h1>PROMIS v2.0</h1>
<h2>Satisfacción con la vida sexual</h2>

<div class="card">
  <p class="small-muted">
    Responda a cada pregunta marcando una opción. Este cuestionario es anónimo salvo indicación contraria.
  </p>
</div>

<form id="promis-form" class="card">

  <!-- Sexo -->
  <div class="question">
    <p>Sexo de referencia para normas PROMIS:</p>
    <div class="options">
      <label><input type="radio" name="sexo_ref" value="F" required> Mujer</label>
      <label><input type="radio" name="sexo_ref" value="M"> Hombre</label>
    </div>
  </div>

  <!-- Ítems -->
  <div class="question">
    <p>SFSAT101 – ¿Hasta qué punto ha estado satisfecho/a con su vida sexual?</p>
    <div class="options">
      <label><input type="radio" name="SFSAT101" value="1" required>1</label>
      <label><input type="radio" name="SFSAT101" value="2">2</label>
      <label><input type="radio" name="SFSAT101" value="3">3</label>
      <label><input type="radio" name="SFSAT101" value="4">4</label>
      <label><input type="radio" name="SFSAT101" value="5">5</label>
    </div>
  </div>

  <div class="question">
    <p>SFSAT102r – ¿Cuánto placer le ha dado su vida sexual?</p>
    <div class="options">
      <label><input type="radio" name="SFSAT102r" value="1" required>1</label>
      <label><input type="radio" name="SFSAT102r" value="2">2</label>
      <label><input type="radio" name="SFSAT102r" value="3">3</label>
      <label><input type="radio" name="SFSAT102r" value="4">4</label>
      <label><input type="radio" name="SFSAT102r" value="5">5</label>
    </div>
  </div>

  <div class="question">
    <p>SFSAT103 – ¿Con qué frecuencia ha pensado que su vida sexual es maravillosa?</p>
    <div class="options">
      <label><input type="radio" name="SFSAT103" value="1" required>1</label>
      <label><input type="radio" name="SFSAT103" value="2">2</label>
      <label><input type="radio" name="SFSAT103" value="3">3</label>
      <label><input type="radio" name="SFSAT103" value="4">4</label>
      <label><input type="radio" name="SFSAT103" value="5">5</label>
    </div>
  </div>

  <div class="question">
    <p>SFSAT201 – ¿Hasta qué punto ha estado satisfecho/a con sus relaciones sexuales?</p>
    <div class="options">
      <label><input type="radio" name="SFSAT201" value="0" required>0 – No he tenido relaciones</label>
      <label><input type="radio" name="SFSAT201" value="1">1</label>
      <label><input type="radio" name="SFSAT201" value="2">2</label>
      <label><input type="radio" name="SFSAT201" value="3">3</label>
      <label><input type="radio" name="SFSAT201" value="4">4</label>
      <label><input type="radio" name="SFSAT201" value="5">5</label>
    </div>
  </div>

  <div class="question">
    <p>SFSAT105r – ¿Cuánto ha disfrutado la actividad sexual? (Descriptivo)</p>
    <div class="options">
      <label><input type="radio" name="SFSAT105r" value="1" required>1</label>
      <label><input type="radio" name="SFSAT105r" value="2">2</label>
      <label><input type="radio" name="SFSAT105r" value="3">3</label>
      <label><input type="radio" name="SFSAT105r" value="4">4</label>
      <label><input type="radio" name="SFSAT105r" value="5">5</label>
    </div>
  </div>

  <button id="submitBtn" type="submit">Enviar</button>
</form>

<div id="resultsCard" class="card">
  <h3>Resultados</h3>
  <textarea id="resultsText" readonly></textarea>
  <button id="copyBtn">Copiar</button>
  <button id="downloadCsvBtn">Descargar CSV</button>
</div>

<script>
/* -----------------------------------
   TABLA RAW → T-SCORE (OFICIAL PROMIS)
   Satisfaction with Sex Life v2.0
--------------------------------------*/

const tScoreTable = {
  4: 30.7,
  5: 35.6,
  6: 37.6,
  7: 39.1,
  8: 40.5,
  9: 41.8,
  10: 43.3,
  11: 44.7,
  12: 46.2,
  13: 47.8,
  14: 49.4,
  15: 51.1,
  16: 52.8,
  17: 54.6,
  18: 56.7,
  19: 59.5,
  20: 65.1
};

/* INTERPRETACIÓN */
function interpretTScore(t) {
  if (t < 40) {
    return "Baja satisfacción sexual (≈ más de 1 DE por debajo del promedio de la población de referencia).";
  } else if (t <= 60) {
    return "Satisfacción con la vida sexual dentro del rango medio (±1 DE alrededor de la media).";
  } else {
    return "Alta satisfacción sexual (≈ más de 1 DE por encima del promedio de la población de referencia).";
  }
}

/* GENERAR CÓDIGO ÚNICO */
function generarIdUnico() {
  const ahora = Date.now().toString(36);
  const rand = Math.random().toString(36).slice(2, 6);
  return "PROMIS-" + ahora + "-" + rand;
}

/* CSV – lista de todos los registros de esta sesión */
const allResults = [];

const formEl = document.getElementById("promis-form");
const resultsCard = document.getElementById("resultsCard");
const resultsText = document.getElementById("resultsText");
const copyBtn = document.getElementById("copyBtn");
const downloadCsvBtn = document.getElementById("downloadCsvBtn");

/* MANEJAR ENVÍO DEL FORMULARIO */
formEl.addEventListener("submit", function(e){
  e.preventDefault();

  const form = new FormData(e.target);
  const sexo = form.get("sexo_ref");

  const s1 = Number(form.get("SFSAT101"));
  const s2 = Number(form.get("SFSAT102r"));
  const s3 = Number(form.get("SFSAT103"));
  const s4 = Number(form.get("SFSAT201"));
  const s5 = Number(form.get("SFSAT105r"));

  // Fecha y hora actuales
  const now = new Date();
  const datetime = now.toISOString();           // 2025-11-20T12:34:56.000Z
  const fecha = datetime.slice(0, 10);          // YYYY-MM-DD
  const hora = datetime.slice(11, 19);          // HH:MM:SS

  // ID único del registro
  const id = generarIdUnico();

  let text = [];

  text.push("PROMIS v2.0 – Satisfacción con la vida sexual (versión española)");
  text.push("Código de registro: " + id);
  text.push("Fecha: " + fecha + "   Hora: " + hora);
  text.push("Sexo de referencia para normas: " + (sexo==="M"?"hombre":"mujer"));
  text.push("");
  text.push("Respuestas (valor numérico):");
  text.push("SFSAT101 – Satisfacción con la vida sexual: " + s1);
  text.push("SFSAT102r – Placer con la vida sexual: " + s2);
  text.push("SFSAT103 – Vida sexual maravillosa (frecuencia): " + s3);
  text.push("SFSAT201 – Satisfacción con relaciones de tipo sexual: " + s4);
  text.push("SFSAT105r – Disfrute de la actividad sexual (descriptivo): " + s5);
  text.push("");

  let raw = null;
  let t = null;
  let interpre = "";

  if (s4 === 0) {
    // Caso PROMIS: no escorable si no hay relaciones sexuales recientes
    interpre = "No se calcula T-score porque la persona informa no haber tenido relaciones sexuales en los últimos 30 días (SFSAT201 = 0). El dominio 'Satisfaction with Sex Life' está calibrado para personas sexualmente activas.";
    text.push("Puntuación bruta (raw score): no calculable.");
    text.push("T-score PROMIS: no calculable.");
    text.push("Interpretación: " + interpre);
  } else {
    raw = s1 + s2 + s3 + s4;
    t = tScoreTable[raw] ?? null;

    if (t == null) {
      interpre = "No se puede calcular T-score para esta puntuación bruta (fuera de rango de la tabla).";
      text.push("Puntuación bruta (raw score): " + raw);
      text.push("T-score PROMIS: no disponible.");
      text.push("Interpretación: " + interpre);
    } else {
      interpre = interpretTScore(t);
      text.push("Puntuación bruta (4 ítems 'Satisfaction with Sex Life'): " + raw);
      text.push("T-score PROMIS: " + t.toFixed(1));
      text.push("Interpretación: " + interpre);
    }
  }

  text.push("");
  text.push("Nota: la métrica T-score PROMIS tiene media 50 y DE 10 en la población de referencia.");

  resultsText.value = text.join("\n");
  resultsCard.style.display = "block";

  // Guardar registro en memoria para CSV (aunque no tenga T-score se guarda igual)
  allResults.push({
    id,
    datetime,
    fecha,
    hora,
    sexo,
    SFSAT101: s1,
    SFSAT102r: s2,
    SFSAT103: s3,
    SFSAT201: s4,
    SFSAT105r: s5,
    rawScore: raw,
    tScore: t,
    interpretacion: interpre
  });
});

/* COPIAR RESULTADOS */
copyBtn.addEventListener("click", () => {
  const txt = resultsText.value;
  if (!txt) return;
  navigator.clipboard.writeText(txt).then(()=>{
    copyBtn.textContent = "Copiado ✔";
    setTimeout(()=> copyBtn.textContent = "Copiar", 1500);
  });
});

/* DESCARGAR CSV */
downloadCsvBtn.addEventListener("click", () => {
  if (allResults.length === 0) {
    alert("Todavía no hay registros en esta sesión.");
    return;
  }

  let csv = "id,datetime,fecha,hora,sexo,SFSAT101,SFSAT102r,SFSAT103,SFSAT201,SFSAT105r,rawScore,tScore,interpretacion\n";

  allResults.forEach(r => {
    const row = [
      r.id,
      r.datetime,
      r.fecha,
      r.hora,
      r.sexo,
      r.SFSAT101,
      r.SFSAT102r,
      r.SFSAT103,
      r.SFSAT201,
      r.SFSAT105r,
      r.rawScore == null ? "" : r.rawScore,
      r.tScore == null ? "" : r.tScore.toFixed ? r.tScore.toFixed(1) : r.tScore,
      '"' + (r.interpretacion || "").replace(/"/g, '""') + '"'
    ].join(",");
    csv += row + "\n";
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "promis_sexlife_scores.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
